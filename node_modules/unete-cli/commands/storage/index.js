const YAML = require('yamljs');
const Contracts = YAML.load(__dirname + '/contracts.yml');
const UneteEthClient = require('unete-eth/client');
const Web3 = require('../web3');
const fs = require('fs');

module.exports = {
    
    async upload (network, file, type) {
        const data = fs.readFileSync(file).toString('base64');
        const ext = type || file.indexOf(".") > -1? file.substring(file.lastIndexOf(".") + 1) : "bin";
        
        const credentials = Web3.data(null, true);
        const client = UneteEthClient(Contracts.contracts[network], credentials);

        if(!client) return console.log('Network not found.'.bold.red);
        
        const tx = await client.save(data, ext);
        const hash = await client.hashOf(data);

        console.log("Transaction: ".bold.cyan + tx.yellow.bold);
        console.log("URL: ".bold.cyan + `${network}@${hash}`.yellow.bold);
    },

    async download (url, output) {
        if(typeof output !== "string") output = null;

        const [ network, hash ] = url.split('@');
        const addr = Contracts.contracts[network];
        
        if(!addr) return console.log('Network not supported.'.bold.red);
        const client = UneteEthClient(addr);

        const data = ({
            type: await client.readtype(hash),
            content: await client.read(hash)
        });

        console.log(`Writing to `.bold.cyan + (output || hash + "." + data.type).bold.yellow + '...');
        fs.writeFileSync(output || hash + "." +data.type, Buffer.from(data.content, 'base64'));
        console.log(`Done.`.bold.cyan);
    }

};